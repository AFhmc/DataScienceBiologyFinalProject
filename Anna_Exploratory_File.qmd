---
title: "Anna Exploratory File"
format: html
editor: visual
---

## 

```{r}
library(tidyverse)
library(lubridate)
```

```{r}
resolution <- "WW"

sites <- c("CA-NS1", "CA-NS2", "CA-NS3", "CA-NS4", "CA-NS5", "CA-NS6", "CA-NS7")

CA_NS1 <- tibble(read.csv(str_c("Data/",sites[1],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS2 <- tibble(read.csv(str_c("Data/",sites[2],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS3 <- tibble(read.csv(str_c("Data/",sites[3],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS4 <- tibble(read.csv(str_c("Data/",sites[4],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS5 <- tibble(read.csv(str_c("Data/",sites[5],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS6 <- tibble(read.csv(str_c("Data/",sites[6],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS7 <- tibble(read.csv(str_c("Data/",sites[7],"/", resolution,".csv"),
                               na.strings = "-9999"))


WW_data <- bind_rows(list("CA-NS1" = CA_NS1,"CA-NS2" = CA_NS2,"CA-NS3" = CA_NS3,"CA-NS4" = CA_NS4,"CA-NS5" = CA_NS5,"CA-NS6" = CA_NS6,"CA-NS7" = CA_NS7), .id = "Site")
```

```{r}
resolution <- "HH"

sites <- c("CA-NS1", "CA-NS2", "CA-NS3", "CA-NS4", "CA-NS5", "CA-NS6", "CA-NS7")

CA_NS1 <- tibble(read.csv(str_c("Data/",sites[1],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS2 <- tibble(read.csv(str_c("Data/",sites[2],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS3 <- tibble(read.csv(str_c("Data/",sites[3],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS4 <- tibble(read.csv(str_c("Data/",sites[4],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS5 <- tibble(read.csv(str_c("Data/",sites[5],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS6 <- tibble(read.csv(str_c("Data/",sites[6],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS7 <- tibble(read.csv(str_c("Data/",sites[7],"/", resolution,".csv"),
                               na.strings = "-9999"))


HH_data <- bind_rows(list("CA-NS1" = CA_NS1,"CA-NS2" = CA_NS2,"CA-NS3" = CA_NS3,"CA-NS4" = CA_NS4,"CA-NS5" = CA_NS5,"CA-NS6" = CA_NS6,"CA-NS7" = CA_NS7), .id = "Site")
```

```{r}
resolution <- "MM"

sites <- c("CA-NS1", "CA-NS2", "CA-NS3", "CA-NS4", "CA-NS5", "CA-NS6", "CA-NS7")

CA_NS1 <- tibble(read.csv(str_c("Data/",sites[1],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS2 <- tibble(read.csv(str_c("Data/",sites[2],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS3 <- tibble(read.csv(str_c("Data/",sites[3],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS4 <- tibble(read.csv(str_c("Data/",sites[4],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS5 <- tibble(read.csv(str_c("Data/",sites[5],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS6 <- tibble(read.csv(str_c("Data/",sites[6],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS7 <- tibble(read.csv(str_c("Data/",sites[7],"/", resolution,".csv"),
                               na.strings = "-9999"))

MM_data <- bind_rows(list("CA-NS1" = CA_NS1,"CA-NS2" = CA_NS2,"CA-NS3" = CA_NS3,"CA-NS4" = CA_NS4,"CA-NS5" = CA_NS5,"CA-NS6" = CA_NS6,"CA-NS7" = CA_NS7), .id = "Site")
```

```{r}
resolution <- "DD"

sites <- c("CA-NS1", "CA-NS2", "CA-NS3", "CA-NS4", "CA-NS5", "CA-NS6", "CA-NS7")

CA_NS1 <- tibble(read.csv(str_c("Data/",sites[1],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS2 <- tibble(read.csv(str_c("Data/",sites[2],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS3 <- tibble(read.csv(str_c("Data/",sites[3],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS4 <- tibble(read.csv(str_c("Data/",sites[4],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS5 <- tibble(read.csv(str_c("Data/",sites[5],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS6 <- tibble(read.csv(str_c("Data/",sites[6],"/", resolution,".csv"),
                               na.strings = "-9999"))

CA_NS7 <- tibble(read.csv(str_c("Data/",sites[7],"/", resolution,".csv"),
                               na.strings = "-9999"))


DD_data <- bind_rows(list("CA-NS1" = CA_NS1,"CA-NS2" = CA_NS2,"CA-NS3" = CA_NS3,"CA-NS4" = CA_NS4,"CA-NS5" = CA_NS5,"CA-NS6" = CA_NS6,"CA-NS7" = CA_NS7), .id = "Site")

```

Get timestamps:

```{r}

DD_data <- DD_data |> mutate(TIMESTAMP = ymd(str_c(str_sub(TIMESTAMP, 1, 4), 
                                                   str_sub(TIMESTAMP, 5, 6), 
                                                   str_sub(TIMESTAMP, 7, 8), sep = '-')))

WW_data <- WW_data |> mutate(TIMESTAMP = ymd(str_c(str_sub(TIMESTAMP_START, 1, 4), 
                                                   str_sub(TIMESTAMP_START, 5, 6), 
                                                   str_sub(TIMESTAMP_START, 7, 8), sep = '-')))

MM_data <- MM_data |> mutate(TIMESTAMP = ym(str_c(str_sub(TIMESTAMP, 1, 4), 
                                                  str_sub(TIMESTAMP, 5, 6), sep = '-')))

HH_data <- HH_data |> mutate(TIMESTAMP = ymd_hm(str_c(str_sub(TIMESTAMP_START, 1, 4), 
                                                            str_sub(TIMESTAMP_START, 5, 6), 
                                                            str_sub(TIMESTAMP_START, 7, 8), 
                                                            str_sub(TIMESTAMP_START, 9, 10), 
                                                            str_sub(TIMESTAMP_START, 11, 12), 
                                                            sep = ' ')))
```

Import MODIS data

```{r}
full_NDVI_data <- read.csv("Data/MODIS_NDVI_data.csv")
#note: currently ignores quality flags
NDVI_data <- full_NDVI_data |> select(ID, Date, MOD13A1_061__500m_16_days_NDVI) |> 
  rename(Site = ID, NDVI = MOD13A1_061__500m_16_days_NDVI) |>
  mutate(Date = ymd(Date))
```

We need to figure out appropriate quality flag filtering, because it automatically tries to interpolate: QC is percent measured/high quality gapfilled data for all but half hourly resolution (where it represents if the data at that half hour is measured or gap filled at a given quality). 70% might be decent? We could also have that be a parameter

```{r}
#Note; this won't work properly on HH data
#Replaces the NEE_VUT_REF values with NA when their QC is less than a threshold
filter_fluxes <- function(flux_df, QC_threshold){
  indexes_to_filter <- flux_df$NEE_VUT_REF_QC < QC_threshold
  flux_df$NEE_VUT_REF <- replace(flux_df$NEE_VUT_REF, indexes_to_filter, NA)
  return(flux_df)
}
```

Plot time series of flux all overlaid (weekly)

```{r}
MM_data |> filter_fluxes(0.8) |> ggplot(aes(x = TIMESTAMP, y = NEE_VUT_REF, color = Site)) + geom_line() +
  labs(x = "Time", y = "NEE", color = "Site")
```

Function to make two column dataframe with each column being some variable at a site

```{r}
make_site_df <- function(data_df, site1, site2, variable){
  site1_data <- data_df |> filter(Site == site1) |> pull(variable)
  site2_data <- data_df |> filter(Site == site2) |> pull(variable)
  return_df <- tibble(site1 = site1_data, site2 = site2_data)
  return(return_df)
}



```

Try plotting that:

```{r}
site1name <- "CA-NS1"
site2name <- "CA-NS6"
variable <-"NEE_VUT_REF"

WW_data |> filter_fluxes(0.8) |> make_site_df(site1name, site2name, variable) |>
  ggplot(aes(x = site1, y = site2)) + geom_point() + 
  labs(x = site1name, y = site2name, title = variable)
```
